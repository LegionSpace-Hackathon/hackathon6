# Nginx 配置文件示例
# 用于解决 SPA 路由与静态资源冲突的问题
# 注意：路由路径保持 /docs/ 不变，但实际文件路径改为 /dcs/

server {
    listen 80;
    server_name your-domain.com;
    root /path/to/your/dist;
    index index.html;

    # 静态资源缓存配置
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # 图片资源（dcs/res/ 目录下的图片，但通过 /docs/ 路径访问）
    location ~ ^/docs/[^/]+/[^/]+/res/ {
        rewrite ^/docs/([^/]+)/([^/]+)/res/(.*)$ /dcs/$1/$2/res/$3 last;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Markdown 文件（dcs/ 目录下的文件，但通过 /docs/ 路径访问）
    location ~ ^/docs/[^/]+/[^/]+/[^/]+\.md$ {
        rewrite ^/docs/([^/]+)/([^/]+)/([^/]+\.md)$ /dcs/$1/$2/$3 last;
        add_header Content-Type "text/markdown; charset=utf-8";
        add_header Cache-Control "public, max-age=3600";
        try_files $uri =404;
    }

    # 其他静态文件（dcs/ 目录下的文件，但通过 /docs/ 路径访问）
    location /docs/ {
        rewrite ^/docs/(.*)$ /dcs/$1 last;
        try_files $uri =404;
    }

    # SPA 路由 - 所有其他请求都返回 index.html
    location / {
        try_files $uri $uri/ /index.html;
        
        # 防止缓存 HTML 文件
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # ============ 安全头配置（生产环境必需） ============
    
    # Content Security Policy - 防止XSS攻击
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: blob:; font-src 'self' data:; connect-src 'self' https://space.tongfudun.com https://event-assistant.tongfudun.com; frame-ancestors 'self'; base-uri 'self'; form-action 'self';" always;
    
    # X-Frame-Options - 防止点击劫持
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # X-Content-Type-Options - 防止MIME类型嗅探
    add_header X-Content-Type-Options "nosniff" always;
    
    # X-XSS-Protection - 启用浏览器XSS过滤器
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Referrer-Policy - 控制Referer信息发送
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Permissions-Policy - 控制浏览器功能访问
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()" always;
    
    # Strict-Transport-Security - 强制HTTPS（仅HTTPS环境启用）
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
}
